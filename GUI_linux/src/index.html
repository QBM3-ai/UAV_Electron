<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>UAV Unified Control Platform</title>
    <link rel="stylesheet" href="styles.css">
    <!-- JSMpeg Player -->
    <script src="https://jsmpeg.com/jsmpeg.min.js"></script>
    <script defer src="renderer.js"></script>
</head>
<body>
    <div id="app-container">
        <!-- Navigation -->
        <div id="nav-bar">
            <button class="nav-btn active" data-target="page-home">无人机综控</button>
            <button class="nav-btn" data-target="page-modeling">3D建模</button>
            
            <div class="auth-container">
                <button id="btn-check-update" class="auth-btn" style="background:transparent; border:1px solid #aaa; color:#aaa; margin-right:10px;">检查更新</button>
                <button id="btn-register" class="auth-btn auth-btn-register">注册</button>
                <button id="btn-login" class="auth-btn auth-btn-login">登录</button>
            </div>
        </div>

        <!-- Page: Home (Flight Control + Video + Data) -->
        <div id="page-home" class="page active">
            
            <!-- Pane Upper: Video / Map / Main View -->
            <div id="pane-upper" class="pane">
                <div class="overlay-toolbar">
                     <button id="btn-launch-qgc" class="btn-float">
                        <span>✈</span> 启动路径规划 (QGC)
                     </button>
                     <button id="btn-stream-sim" class="btn-float">
                        <span>⚡</span> 虚拟图传
                     </button>
                     <button id="btn-stream-connect" class="btn-float">
                        <span>📡</span> 连接图传
                     </button>
                </div>

                <div class="overlay-toolbar-right">
                     <button id="btn-snap" class="btn-float">
                        <span>📷</span> 拍照
                     </button>
                     <button id="btn-record" class="btn-float">
                        <span>⏺</span> 录像
                     </button>
                     <button id="btn-media-settings" class="btn-float">
                        <span>⚙</span> 设置
                     </button>
                </div>
                
                <div class="pane-content" style="padding: 0;">
                    <!-- JSMpeg Canvas -->
                    <div id="video-placeholder" style="width: 100%; height: 100%; background: #000; position: relative;">
                        <!-- Canvas fills the container -->
                        <canvas id="video-canvas" style="width: 100%; height: 100%; object-fit: contain;"></canvas>
                        
                        <!-- Removed old overlay controls -->
                        
                        <!-- Modals moved to body end for correct z-index layering -->
                    </div>
                </div>
            </div>

            <!-- Resizer Handle -->
            <div id="resizer"></div>

            <!-- Pane Lower: Data Monitor -->
            <div id="pane-lower" class="pane">
                <div class="pane-header">
                    <span>实时状态监控</span>
                    <div class="pane-controls">
                        <!-- Controls if needed -->
                    </div>
                </div>
                <div class="pane-content" style="display: block; overflow-y: auto;">
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">高度 (Alt)</div>
                            <div class="data-value" id="val-alt">--- m</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">速度 (Speed)</div>
                            <div class="data-value" id="val-speed">--- m/s</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">电池 (Batt)</div>
                            <div class="data-value" id="val-batt">-- %</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">GPS 卫星</div>
                            <div class="data-value" id="val-gps">0</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">飞行模式</div>
                            <div class="data-value" id="val-mode">DISARMED</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">姿态 (Pitch/Roll)</div>
                            <div class="data-value" id="val-att">0 / 0</div>
                        </div>
                    </div>
                    <!-- Simulate connection -->
                    <div style="margin-top: 10px; text-align: right;">
                        <button id="btn-connect-mavlink" class="btn-primary" style="font-size: 10px; padding: 2px 6px;">连接数据流 (模拟)</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Page: 3D Modeling -->
        <div id="page-modeling" class="page" style="display: none;"> <!-- helper style default none -->
             <div class="modeling-status">
                <h3>服务器连接与建模控制</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-primary" id="btn-connect-server">连接服务器</button>
                    <button class="btn-primary" id="btn-upload-data" disabled>上传图传数据</button>
                    <button class="btn-primary" id="btn-test-ply" style="background-color: #6c757d;">🛠 测试 3D 演化</button>
                    <span id="server-status" style="color: #666; margin-left: 10px;">状态: 未连接</span>
                </div>
                <div style="margin-top: 15px;">
                    <progress id="upload-progress" value="0" max="100" style="width: 100%; display: none;"></progress>
                </div>
             </div>
             
             <div class="modeling-viewer">
                 <div>
                     <h2>3D 结果展示区</h2>
                     <p>等待建模结果...</p>
                 </div>
             </div>
        </div>

    </div>

    <!-- Modals (Global Level) -->
    <!-- Stream Config Modal -->
    <div id="stream-config-modal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: #333; border: 1px solid #555; box-shadow: 0 4px 15px rgba(0,0,0,0.8); z-index: 9999;">
        <!-- Header for dragging -->
        <h3 style="margin: 0; padding: 15px 20px; background: #2d2d2d; cursor: move; border-bottom: 1px solid #444; font-size: 14px; color: #eee; user-select: none;">图传连接配置</h3>
        
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 12px; margin-bottom: 5px; color: #ccc;">视频流地址 (Websocket/RTSP proxy):</label>
                <input type="text" id="stream-url-input" value="ws://localhost:9999" style="width: 100%; box-sizing: border-box; padding: 5px; background: #222; color: white; border: 1px solid #444;">
            </div>
            <div style="text-align: right;">
                <button id="btn-stream-cancel" style="padding: 6px 12px; background: #555; color: white; border: none; cursor: pointer; border-radius: 2px;">取消</button>
                <button id="btn-stream-confirm" style="padding: 6px 12px; background: #007acc; color: white; border: none; cursor: pointer; border-radius: 2px; margin-left: 5px;">连接</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="media-settings-modal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; background: #333; border: 1px solid #555; box-shadow: 0 4px 15px rgba(0,0,0,0.8); z-index: 9999;">
        <!-- Header for dragging -->
        <h3 style="margin: 0; padding: 15px 20px; background: #2d2d2d; cursor: move; border-bottom: 1px solid #444; font-size: 14px; color: #eee; user-select: none;">媒体存储配置</h3>
        
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 12px; margin-bottom: 5px; color: #ccc;">截图保存路径:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="snap-path-input" readonly style="flex: 1; box-sizing: border-box; padding: 5px; background: #222; color: #aaa; border: 1px solid #444; font-size: 11px;">
                    <button id="btn-browse-snap" style="padding: 2px 8px; background: #555; color: white; border: none; cursor: pointer;">浏览</button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 12px; margin-bottom: 5px; color: #ccc;">录像保存路径:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="record-path-input" readonly style="flex: 1; box-sizing: border-box; padding: 5px; background: #222; color: #aaa; border: 1px solid #444; font-size: 11px;">
                    <button id="btn-browse-record" style="padding: 2px 8px; background: #555; color: white; border: none; cursor: pointer;">浏览</button>
                </div>
            </div>

            <div style="text-align: right;">
                <button id="btn-settings-close" style="padding: 6px 12px; background: #007acc; color: white; border: none; cursor: pointer; border-radius: 2px;">关闭</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification">Notification</div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <button id="btn-close-login" class="modal-close-btn">&times;</button>
            <h2 class="modal-title">登录</h2>
            <div class="input-group">
                <input type="text" id="login-account" class="modal-input" placeholder="手机号/邮箱">
            </div>
            <div class="input-group">
                <input type="password" id="login-password" class="modal-input" placeholder="密码">
            </div>
            <button id="btn-submit-login" class="btn-primary" style="width: 100%; margin-top: 10px;">登录</button>
            <div class="modal-footer">
                <span class="text-link">忘记密码？</span>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal-overlay">
        <div class="modal-box">
            <button id="btn-close-register" class="modal-close-btn">&times;</button>
            <h2 class="modal-title">注册账号</h2>
            <div class="input-group">
                <input type="text" id="reg-account" class="modal-input" placeholder="请输入邮箱地址">
            </div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <input type="text" id="reg-code" class="modal-input" placeholder="验证码" style="flex: 1;">
                <button id="btn-send-code" class="btn-primary" style="margin-top: 0; padding: 0 10px; font-size: 12px; white-space: nowrap;">获取验证码</button>
            </div>
            <div class="input-group">
                <input type="password" id="reg-password" class="modal-input" placeholder="设置密码">
            </div>
            <button id="btn-submit-register" class="btn-primary" style="width: 100%; margin-top: 10px; background-color: #28a745;">立即注册</button>
        </div>
    </div>

    <!-- Download Progress Modal -->
    <div id="download-modal" class="modal-overlay">
        <div class="modal-box" style="width: 400px;">
            <h2 class="modal-title" style="cursor: move;">正在下载更新</h2>
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #ccc; font-size: 14px;">
                    <span id="download-status-speed">0 KB/s</span>
                    <span id="download-status-percent">0%</span>
                </div>
                <!-- Progress Bar Container -->
                <div style="width: 100%; background: #333; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #444;">
                    <div id="download-progress-bar" style="width: 0%; background: #4ec9b0; height: 100%; transition: width 0.2s ease-out; box-shadow: 0 0 10px rgba(78, 201, 176, 0.5);"></div>
                </div>
                <div style="text-align: right; margin-top: 5px; font-size: 12px; color: #888;">
                    <span id="download-status-size">0 / 0 MB</span>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center;">
                <span style="font-size: 12px; color: #666;">请勿关闭程序，下载完成后将自动安装</span>
            </div>
        </div>
    </div>

</body>
</html>
